#!/usr/bin/bash
# 
# This file is managed by chef
# Changes will be overwritten
#

<%= node['pg']['bin']%>/pg_basebackup -v -D <%= node['pg']['hadr']['base_bkp'] %>/$(<%= node['pg']['hadr']['name_fmt'] %>)

if [[ 0 -lt `find <%= node['pg']['hadr']['base_bkp'] %>* -type d -ctime +<%= node['pg']['hadr']['retention_days'] %>` ]]
then
    echo "deleting media older than <%= node['pg']['hadr']['retention_days'] %> days..."
    echo 
    find <%= node['pg']['hadr']['base_bkp'] %>* -type d -ctime +<%= node['pg']['hadr']['retention_days'] %> | xargs rm -rv {} 
fi
